name: Build and Deploy

on:
  push:
    branches:
      - main

permissions:
  contents: write
  packages: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # --- Kontrollera filer ---
      - name: List backend directory
        run: |
          echo "Files in backend/:"
          ls -la backend/

      # --- Build and push frontend ---
      - name: Build and push frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Containerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/guestbook-automation-pipeline-frontend:${{ github.sha }}
            ghcr.io/${{ github.repository_owner }}/guestbook-automation-pipeline-frontend:latest

      # --- Build and push backend ---
      - name: Build and push backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Containerfile  # <--- Ã„ndra detta om filen heter Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/guestbook:latest

      # --- Install and login to OpenShift ---
      - name: Install OpenShift CLI
        run: |
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/oc/latest/linux/oc.tar.gz
          tar -xzf oc.tar.gz
          sudo mv oc /usr/local/bin/
          rm oc.tar.gz

      - name: Login to OpenShift
        run: |
          oc login \
            --token=${{ secrets.OCP_TOKEN }} \
            --insecure-skip-tls-verify \
            --server=https://api.devops24.cloud2.se:6443

      - name: Deploy on OpenShift
        run: |
          oc project test-miljo2
          oc apply -f config.yaml
          oc apply -f backend.yaml
          oc apply -f frontend.yaml
          oc apply -f secrets.yaml
