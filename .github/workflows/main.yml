name: Build and Deploy

on:
  push:
    branches:
      - main

permissions:
  contents: read
  packages: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push containers
        run: |
          # Backend
          docker build \
            -t ghcr.io/arash00009/guestbook-backend:${{ github.sha }} \
            -t ghcr.io/arash00009/guestbook-backend:latest \
            ./backend
          
          # Frontend
          docker build \
            -t ghcr.io/arash00009/guestbook-frontend:${{ github.sha }} \
            -t ghcr.io/arash00009/guestbook-frontend:latest \
            ./frontend
          
          # Push
          docker push ghcr.io/arash00009/guestbook-backend:${{ github.sha }}
          docker push ghcr.io/arash00009/guestbook-backend:latest
          docker push ghcr.io/arash00009/guestbook-frontend:${{ github.sha }}
          docker push ghcr.io/arash00009/guestbook-frontend:latest

      - name: Install OpenShift CLI
        run: |
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/oc/latest/linux/oc.tar.gz
          tar -xzf oc.tar.gz
          sudo mv oc /usr/local/bin/
          rm oc.tar.gz

      - name: Login to OpenShift
        run: |
          oc login \
            --token=${{ secrets.OCP_TOKEN }} \
            --insecure-skip-tls-verify \
            --server=https://api.devops24.cloud2.se:6443

      - name: Switch to test-miljo1 project
        run: |
          oc project test-miljo1 || oc new-project test-miljo1

      - name: Create missing YAML files
        run: |
          # === Skapa config.yaml ===
          cat > config.yaml << EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: guestbook-config
data:
  APP_ENV: "production"
  APP_DEBUG: "false"
  BACKEND_URL: "http://guestbook-backend:5000"
EOF
          echo "âœ… Created config.yaml"

          # === Skapa backend.yaml ===
          cat > backend.yaml << EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: guestbook-backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: guestbook-backend
  template:
    metadata:
      labels:
        app: guestbook-backend
    spec:
      containers:
      - name: backend
        image: ghcr.io/arash00009/guestbook-backend:latest
        ports:
        - containerPort: 5000
        envFrom:
        - configMapRef:
            name: guestbook-config
---
apiVersion: v1
kind: Service
metadata:
  name: guestbook-backend
spec:
  selector:
    app: guestbook-backend
  ports:
  - port: 5000
    targetPort: 5000
EOF
          echo "âœ… Created backend.yaml"

          # === Skapa frontend.yaml ===
          cat > frontend.yaml << EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: guestbook-frontend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: guestbook-frontend
  template:
    metadata:
      labels:
        app: guestbook-frontend
    spec:
      containers:
      - name: frontend
        image: ghcr.io/arash00009/guestbook-frontend:latest
        ports:
        - containerPort: 3000
        env:
        - name: REACT_APP_API_URL
          value: "http://guestbook-backend:5000"
---
apiVersion: v1
kind: Service
metadata:
  name: guestbook-frontend
spec:
  selector:
    app: guestbook-frontend
  ports:
  - port: 3000
    targetPort: 3000
  type: ClusterIP
EOF
          echo "âœ… Created frontend.yaml"

          # === Skapa secrets.yaml ===
          cat > secrets.yaml << EOF
apiVersion: v1
kind: Secret
metadata:
  name: guestbook-secrets
type: Opaque
stringData:
  SECRET_KEY: "change-this-in-production"
EOF
          echo "âœ… Created secrets.yaml"

      - name: Deploy to OpenShift
        run: |
          echo "ğŸ“¦ Deploying to OpenShift..."
          oc apply -f config.yaml
          oc apply -f backend.yaml
          oc apply -f frontend.yaml
          oc apply -f secrets.yaml

      - name: Create Routes (Optional)
        run: |
          # Create route for frontend if not exists
          if ! oc get route guestbook-frontend 2>/dev/null; then
            oc expose service guestbook-frontend --port=3000
            echo "âœ… Created route for frontend"
          fi
          
          # Create route for backend if needed
          if ! oc get route guestbook-backend 2>/dev/null; then
            oc expose service guestbook-backend --port=5000
            echo "âœ… Created route for backend"
          fi
          
          echo "ğŸ“Š Deployment status:"
          oc get pods
          echo ""
          echo "ğŸŒ Routes:"
          oc get routes
