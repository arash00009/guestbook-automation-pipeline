name: Build and Deploy

on:
  push:
    branches:
      - main

permissions:
  contents: read
  packages: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug - Show file structure
        run: |
          echo "=== Current directory structure ==="
          pwd
          ls -la
          echo ""
          echo "=== Looking for config.yaml ==="
          find . -name "config.yaml" -type f
          echo ""
          echo "=== Contents of .github/workflows/ ==="
          ls -la .github/workflows/
          echo ""
          echo "=== YAML files in repository ==="
          find . -name "*.yaml" -o -name "*.yml" | sort

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push containers
        run: |
          # Backend
          docker build \
            -t ghcr.io/arash00009/guestbook-backend:${{ github.sha }} \
            -t ghcr.io/arash00009/guestbook-backend:latest \
            ./backend
          
          # Frontend
          docker build \
            -t ghcr.io/arash00009/guestbook-frontend:${{ github.sha }} \
            -t ghcr.io/arash00009/guestbook-frontend:latest \
            ./frontend
          
          # Push
          docker push ghcr.io/arash00009/guestbook-backend:${{ github.sha }}
          docker push ghcr.io/arash00009/guestbook-backend:latest
          docker push ghcr.io/arash00009/guestbook-frontend:${{ github.sha }}
          docker push ghcr.io/arash00009/guestbook-frontend:latest

      - name: Install OpenShift CLI
        run: |
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/oc/latest/linux/oc.tar.gz
          tar -xzf oc.tar.gz
          sudo mv oc /usr/local/bin/
          rm oc.tar.gz

      - name: Login to OpenShift
        run: |
          oc login \
            --token=${{ secrets.OCP_TOKEN }} \
            --insecure-skip-tls-verify \
            --server=https://api.devops24.cloud2.se:6443

      - name: Switch to test-miljo1 project
        run: |
          oc project test-miljo1 || oc new-project test-miljo1

      - name: Deploy Kubernetes/OpenShift manifests (Correct paths)
        run: |
          echo "=== Deploying Manifests ==="
          
          # Hitta och applicera config.yaml oavsett var den ligger
          if [ -f ".github/workflows/config.yaml" ]; then
            echo "Found config.yaml in .github/workflows/"
            oc apply -f .github/workflows/config.yaml
          elif [ -f "config.yaml" ]; then
            echo "Found config.yaml in root"
            oc apply -f config.yaml
          else
            echo "ERROR: No config.yaml found!"
            exit 1
          fi
          
          # Hitta och applicera andra deployment filer
          # Titta först i root, sedan i k8s/ mapp om den finns
          
          # Backend deployment
          if [ -f "backend.yaml" ]; then
            oc apply -f backend.yaml
          elif [ -f "k8s/backend.yaml" ]; then
            oc apply -f k8s/backend.yaml
          elif [ -f "deploy/backend.yaml" ]; then
            oc apply -f deploy/backend.yaml
          else
            echo "Creating backend.yaml since it doesn't exist..."
            cat > backend.yaml << EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: guestbook-backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: guestbook-backend
  template:
    metadata:
      labels:
        app: guestbook-backend
    spec:
      containers:
      - name: backend
        image: ghcr.io/arash00009/guestbook-backend:latest
        ports:
        - containerPort: 5000
        env:
        - name: REDIS_HOST
          value: redis
        - name: REDIS_PORT
          value: "6379"
        - name: POSTGRES_HOST
          value: postgres
        - name: POSTGRES_DB
          value: guestbook
---
apiVersion: v1
kind: Service
metadata:
  name: guestbook-backend
spec:
  selector:
    app: guestbook-backend
  ports:
  - port: 5000
    targetPort: 5000
EOF
            oc apply -f backend.yaml
          fi
          
          # Frontend deployment
          if [ -f "frontend.yaml" ]; then
            oc apply -f frontend.yaml
          elif [ -f "k8s/frontend.yaml" ]; then
            oc apply -f k8s/frontend.yaml
          elif [ -f "deploy/frontend.yaml" ]; then
            oc apply -f deploy/frontend.yaml
          else
            echo "Creating frontend.yaml since it doesn't exist..."
            cat > frontend.yaml << EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: guestbook-frontend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: guestbook-frontend
  template:
    metadata:
      labels:
        app: guestbook-frontend
    spec:
      containers:
      - name: frontend
        image: ghcr.io/arash00009/guestbook-frontend:latest
        ports:
        - containerPort: 3000
        env:
        - name: REACT_APP_BACKEND_URL
          value: "http://guestbook-backend:5000"
---
apiVersion: v1
kind: Service
metadata:
  name: guestbook-frontend
spec:
  selector:
    app: guestbook-frontend
  ports:
  - port: 3000
    targetPort: 3000
EOF
            oc apply -f frontend.yaml
          fi
          
          # Secrets (om den finns)
          if [ -f "secrets.yaml" ]; then
            oc apply -f secrets.yaml
          elif [ -f ".github/workflows/secrets.yaml" ]; then
            oc apply -f .github/workflows/secrets.yaml
          fi

      - name: Verify deployment
        run: |
          echo "=== Checking deployment ==="
          sleep 10  # Vänta lite på att poddar ska starta
          oc get all
          echo ""
          echo "=== Pod status ==="
          oc get pods
          echo ""
          echo "=== Services ==="
          oc get services
