name: Build and Deploy

on:
  push:
    branches:
      - main

permissions:
  contents: read
  packages: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: List all files for debugging
        run: |
          echo "=== All files in repository ==="
          find . -type f -name "*.yaml" -o -name "*.yml" -o -name "*.yaml.tpl" | sort
          echo ""
          echo "=== Directory structure ==="
          ls -la
          echo ""
          echo "=== Files that might be deployment files ==="
          find . -type f \( -name "*.yaml" -o -name "*.yml" \) -exec ls -la {} \;

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push containers
        run: |
          # Check and build backend
          if [ -f "backend/Dockerfile" ]; then
            docker build -f backend/Dockerfile \
              -t ghcr.io/arash00009/guestbook-backend:${{ github.sha }} \
              -t ghcr.io/arash00009/guestbook-backend:latest \
              ./backend
          elif [ -f "backend/Containerfile" ]; then
            docker build -f backend/Containerfile \
              -t ghcr.io/arash00009/guestbook-backend:${{ github.sha }} \
              -t ghcr.io/arash00009/guestbook-backend:latest \
              ./backend
          else
            echo "Building backend from root Dockerfile"
            docker build -t ghcr.io/arash00009/guestbook-backend:${{ github.sha }} \
              -t ghcr.io/arash00009/guestbook-backend:latest \
              -f Dockerfile.backend .
          fi

          # Check and build frontend
          if [ -f "frontend/Dockerfile" ]; then
            docker build -f frontend/Dockerfile \
              -t ghcr.io/arash00009/guestbook-frontend:${{ github.sha }} \
              -t ghcr.io/arash00009/guestbook-frontend:latest \
              ./frontend
          elif [ -f "frontend/Containerfile" ]; then
            docker build -f frontend/Containerfile \
              -t ghcr.io/arash00009/guestbook-frontend:${{ github.sha }} \
              -t ghcr.io/arash00009/guestbook-frontend:latest \
              ./frontend
          else
            echo "Building frontend from root Dockerfile"
            docker build -t ghcr.io/arash00009/guestbook-frontend:${{ github.sha }} \
              -t ghcr.io/arash00009/guestbook-frontend:latest \
              -f Dockerfile.frontend .
          fi

          # Push all images
          docker push ghcr.io/arash00009/guestbook-backend:${{ github.sha }}
          docker push ghcr.io/arash00009/guestbook-backend:latest
          docker push ghcr.io/arash00009/guestbook-frontend:${{ github.sha }}
          docker push ghcr.io/arash00009/guestbook-frontend:latest

      - name: Install OpenShift CLI
        run: |
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/oc/latest/linux/oc.tar.gz
          tar -xzf oc.tar.gz
          sudo mv oc /usr/local/bin/
          rm oc.tar.gz

      - name: Login to OpenShift
        run: |
          oc login \
            --token=${{ secrets.OCP_TOKEN }} \
            --insecure-skip-tls-verify \
            --server=https://api.devops24.cloud2.se:6443

      - name: Create or use OpenShift project
        run: |
          oc project test-miljo2 || oc new-project test-miljo2

      - name: Check for deployment files and create if missing
        run: |
          echo "=== Checking for deployment files ==="
          
          # Check and create config.yaml if missing
          if [ ! -f "config.yaml" ]; then
            echo "Creating config.yaml..."
            cat > config.yaml << EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: guestbook-config
data:
  APP_NAME: "Guestbook App"
  ENVIRONMENT: "production"
EOF
          fi
          
          # Check and create backend.yaml if missing
          if [ ! -f "backend.yaml" ]; then
            echo "Creating backend.yaml..."
            cat > backend.yaml << EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: guestbook-backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: guestbook-backend
  template:
    metadata:
      labels:
        app: guestbook-backend
    spec:
      containers:
      - name: guestbook-backend
        image: ghcr.io/arash00009/guestbook-backend:latest
        ports:
        - containerPort: 5000
        env:
        - name: REDIS_HOST
          value: "guestbook-redis"
---
apiVersion: v1
kind: Service
metadata:
  name: guestbook-backend
spec:
  selector:
    app: guestbook-backend
  ports:
  - port: 5000
    targetPort: 5000
EOF
          fi
          
          # Check and create frontend.yaml if missing
          if [ ! -f "frontend.yaml" ]; then
            echo "Creating frontend.yaml..."
            cat > frontend.yaml << EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: guestbook-frontend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: guestbook-frontend
  template:
    metadata:
      labels:
        app: guestbook-frontend
    spec:
      containers:
      - name: guestbook-frontend
        image: ghcr.io/arash00009/guestbook-frontend:latest
        ports:
        - containerPort: 3000
---
apiVersion: v1
kind: Service
metadata:
  name: guestbook-frontend
spec:
  selector:
    app: guestbook-frontend
  ports:
  - port: 3000
    targetPort: 3000
  type: ClusterIP
EOF
          fi
          
          # Check and create secrets.yaml if missing
          if [ ! -f "secrets.yaml" ]; then
            echo "Creating secrets.yaml..."
            cat > secrets.yaml << EOF
apiVersion: v1
kind: Secret
metadata:
  name: guestbook-secrets
type: Opaque
stringData:
  DATABASE_URL: "postgresql://user:password@localhost/db"
  API_KEY: "your-api-key-here"
EOF
          fi
          
          echo "=== Listing created files ==="
          ls -la *.yaml

      - name: Deploy on OpenShift
        run: |
          echo "Applying configuration files..."
          oc apply -f config.yaml
          oc apply -f backend.yaml
          oc apply -f frontend.yaml
          oc apply -f secrets.yaml
          
          echo "=== Deployment status ==="
          oc get pods
          oc get services
          oc get deployments

      - name: Expose services
        run: |
          # Expose backend service if not already exposed
          if ! oc get route guestbook-backend 2>/dev/null; then
            oc expose service guestbook-backend
          fi
          
          # Expose frontend service if not already exposed
          if ! oc get route guestbook-frontend 2>/dev/null; then
            oc expose service guestbook-frontend
          fi
          
          echo "=== Routes ==="
          oc get routes
